

-- Converted order_date column from text to date to enable correct sorting,date hierarchy, 
-- and time intelligence calculations

alter  table orders modify column order_date DATE ;

-- Data sanity & quality checks


-- total rows
SELECT COUNT(*) FROM orders;
SELECT COUNT(*) FROM products_table;
SELECT COUNT(*) FROM order_item_table;

-- check nulls
SELECT COUNT(*) FROM orders WHERE order_date IS NULL OR region IS NULL;
SELECT COUNT(*) FROM order_item_table WHERE quantity IS NULL OR sales IS NULL or profit is null;

-- invalid joins check
SELECT COUNT(*)
FROM order_item_table oi
LEFT JOIN orders o ON oi.order_id = o.order_id
WHERE o.order_id IS NULL;

-- Negative profit check
SELECT *
FROM order_item_table
WHERE profit < 0;

-- Zero sales check
SELECT *
FROM order_item_table
WHERE sales = 0;


-- Basic understanding queries


-- date range


SELECT 
    MIN(order_date) AS start_date,
    MAX(order_date) AS end_date
FROM orders;

-- distinct counts
SELECT COUNT(DISTINCT order_id) FROM orders;
SELECT COUNT(DISTINCT product_id) FROM order_item_table;
SELECT COUNT(DISTINCT region) FROM orders;


-- Core KPIs


-- total sales & profit
SELECT 
    SUM(sales) AS total_sales,
    SUM(profit) AS total_profit
FROM order_item_table;

-- overall profit margin percentage
SELECT 
    ROUND(SUM(profit) / SUM(sales) * 100, 2) AS profit_margin_pct
FROM order_item_table;

-- Cataegory-wise performance


SELECT 
    p.category,
    ROUND(SUM(oi.sales), 2) AS total_sales,
    ROUND(SUM(oi.profit), 2) AS total_profit
FROM order_item_Table oi
JOIN products_table p ON oi.product_id = p.product_id
GROUP BY p.category
ORDER BY total_sales DESC;

-- Region-wise Analysis


SELECT 
    o.region,
    ROUND(SUM(oi.sales), 2) AS total_sales,
    ROUND(SUM(oi.profit), 2) AS total_profit
FROM orders o
JOIN order_item_table oi ON o.order_id = oi.order_id
GROUP BY o.region
ORDER BY total_sales DESC;


-- Monthly sales trend

SELECT 
    DATE_FORMAT(o.order_date, '%Y-%m') AS month,
    ROUND(SUM(oi.sales), 2) AS monthly_sales
FROM orders o
JOIN order_item_table oi ON o.order_id = oi.order_id
GROUP BY month
ORDER BY month;

-- Product performance

SELECT 
    p.product_name,
    ROUND(SUM(oi.sales), 2) AS total_sales,
    RANK() OVER (ORDER BY SUM(oi.sales) DESC) AS sales_rank
FROM order_item_table oi
JOIN products_table p ON oi.product_id = p.product_id
GROUP BY p.product_name;

-- Top & bottom products
-- top 5

SELECT 
    p.product_name,
    SUM(oi.sales) AS total_sales
FROM order_item_table oi
JOIN products_table p ON oi.product_id = p.product_id
GROUP BY p.product_name
ORDER BY total_sales DESC
LIMIT 5;

-- Loss making products

SELECT 
    p.product_name,
    SUM(oi.profit) AS total_profit
FROM order_item_table oi
JOIN products_table p ON oi.product_id = p.product_id
GROUP BY p.product_name
HAVING total_profit < 0
ORDER BY total_profit;

-- Advance Analysis


-- Month-over-Month sales growth

WITH monthly_sales AS (
    SELECT 
        DATE_FORMAT(o.order_date, '%Y-%m') AS month,
        SUM(oi.sales) AS sales
    FROM orders o
    JOIN order_item_table oi ON o.order_id = oi.order_id
    GROUP BY month
)
SELECT 
    month,
    sales,
    sales - LAG(sales) OVER (ORDER BY month) AS mom_change
FROM monthly_sales;

-- Cumulative sales

SELECT 
    DATE_FORMAT(o.order_date, '%Y-%m') AS month,
    SUM(oi.sales) AS monthly_sales,
    SUM(SUM(oi.sales)) OVER (ORDER BY DATE_FORMAT(o.order_date, '%Y-%m')) AS cumulative_sales
FROM orders o
JOIN order_item_table oi ON o.order_id = oi.order_id
GROUP BY month
ORDER BY month;





	
